# AITO Agent Base Dockerfile
# Contains Claude Code CLI for AI-powered agents
# Used by CEO, DAO, CMO, CTO, CFO, COO, CCO

FROM node:20-slim AS base

# Install required tools
RUN apt-get update && apt-get install -y \
    procps \
    curl \
    bash \
    git \
    jq \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/dash /bin/sh

# Install GitHub CLI (gh) for PR workflow
RUN curl -fsSL https://github.com/cli/cli/releases/download/v2.63.2/gh_2.63.2_linux_amd64.tar.gz | tar xz \
    && mv gh_2.63.2_linux_amd64/bin/gh /usr/local/bin/ \
    && rm -rf gh_2.63.2_linux_amd64

# Install Claude Code CLI
# Methode 1: npm (bevorzugt)
# Methode 2: curl install script (fallback)
# Methode 3: Ollama-Wrapper (wenn beides fehlschlÃ¤gt)
RUN npm install -g @anthropic-ai/claude-code@latest || \
    (echo "Trying curl install..." && \
     curl -fsSL https://claude.ai/cli/install.sh | sh) || \
    (echo "Creating Ollama fallback wrapper..." && \
     printf '#!/bin/bash\n\
PROMPT="$*"\n\
if [ -z "$PROMPT" ]; then\n\
    echo "Usage: claude [prompt]"\n\
    exit 1\n\
fi\n\
if [ "$1" = "--version" ]; then\n\
    echo "Claude CLI v1.0.0-aito (Ollama Fallback)"\n\
    exit 0\n\
fi\n\
if [ "$1" = "--print" ]; then\n\
    shift\n\
    PROMPT="$*"\n\
fi\n\
if curl -s http://ollama:11434/api/tags >/dev/null 2>&1; then\n\
    curl -s -X POST http://ollama:11434/api/generate \\n\
        -H "Content-Type: application/json" \\n\
        -d "{\"model\":\"llama3.2:3b\",\"prompt\":\"$PROMPT\",\"stream\":false}" \\n\
        | jq -r ".response" 2>/dev/null\n\
else\n\
    echo "AI backend not available"\n\
    exit 1\n\
fi\n' > /usr/local/bin/claude && chmod +x /usr/local/bin/claude)

# Install Gemini CLI (for parallel LLM usage)
RUN npm install -g @google/gemini-cli@latest || echo "Gemini CLI installation failed (non-critical)"

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Build stage
FROM base AS builder
RUN npm ci
COPY tsconfig.json tsconfig.build.json ./
COPY src ./src
RUN npm run build

# Build custom MCP servers
COPY mcp-servers ./mcp-servers

# Build shared library first (dependency for other MCP servers)
RUN cd mcp-servers/shared && npm ci && npm run build || true

# Build individual MCP servers
RUN cd mcp-servers/fetch-validated && npm ci && npm run build
RUN cd mcp-servers/imagen-mcp && npm ci && npm run build || true
RUN cd mcp-servers/telegram-mcp && npm ci && npm run build || true
RUN cd mcp-servers/git-mcp && npm ci && npm run build || true
RUN cd mcp-servers/shell-mcp && npm ci && npm run build || true
RUN cd mcp-servers/portainer-mcp && npm ci && npm run build || true
RUN cd mcp-servers/woodpecker-mcp && npm ci && npm run build || true
RUN cd mcp-servers/qdrant-mcp && npm ci && npm run build || true
RUN cd mcp-servers/nginx-mcp && npm ci && npm run build || true
RUN cd mcp-servers/certbot-mcp && npm ci && npm run build || true
RUN cd mcp-servers/dns-mcp && npm ci && npm run build || true

# Production stage
FROM node:20-slim AS production

# Build args for CLI feature flags
ARG INSTALL_CLAUDE_CLI=true
ARG INSTALL_GEMINI_CLI=true
ARG INSTALL_CODEX_CLI=false

# Install runtime tools + fonts for SVG text rendering (imagen branding)
RUN apt-get update && apt-get install -y \
    procps \
    curl \
    bash \
    git \
    jq \
    ca-certificates \
    fontconfig \
    fonts-dejavu-core \
    && rm -rf /var/lib/apt/lists/* \
    && fc-cache -f -v \
    && ln -sf /usr/bin/dash /bin/sh

# Install CLI tools based on feature flags
RUN if [ "$INSTALL_CLAUDE_CLI" = "true" ]; then \
        echo "Installing Claude CLI..." && \
        npm install -g @anthropic-ai/claude-code@latest || true; \
    fi && \
    if [ "$INSTALL_GEMINI_CLI" = "true" ]; then \
        echo "Installing Gemini CLI..." && \
        npm install -g @google/gemini-cli@latest || true; \
    fi && \
    if [ "$INSTALL_CODEX_CLI" = "true" ]; then \
        echo "Installing Codex CLI..." && \
        npm install -g @openai/codex@latest || true; \
    fi

# Copy Claude CLI from base (fallback if npm failed)
COPY --from=base /usr/local/bin/claude /usr/local/bin/claude

# Copy GitHub CLI from base
COPY --from=base /usr/local/bin/gh /usr/local/bin/gh

# Create non-root user
RUN groupadd -g 1001 aito && \
    useradd -r -u 1001 -g aito agent

WORKDIR /app

# Copy production files
COPY --from=base /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY package*.json ./

# Copy agent profiles into image (no volume mount needed for Portainer API)
COPY profiles ./profiles

# Copy Claude config (agents, commands, mcp_servers) to base location
# Will be merged into /app/.claude on startup (volume mount overwrites direct copy)
COPY .claude ./claude-base

# Copy custom MCP servers from builder (pre-built)
COPY --from=builder /app/mcp-servers ./mcp-servers

# Create directories for agent
RUN mkdir -p \
    /app/.claude \
    /app/.gemini \
    /app/logs \
    /app/memory \
    /app/workspace \
    /app/projects && \
    chown -R agent:aito /app

# Environment
ENV NODE_ENV=production
ENV LOG_LEVEL=info
ENV HOME=/app

# Claude config directory (for persistent auth)
ENV CLAUDE_CONFIG_DIR=/app/.claude

# Gemini config directory (for persistent auth)
ENV GEMINI_CONFIG_DIR=/app/.gemini

# Switch to non-root user
USER agent

# Configure git safe.directory for workspace and projects (fixes "dubious ownership" with volume mounts)
# Must run AFTER USER switch so config is written to agent's home
RUN git config --global --add safe.directory /app/workspace && \
    git config --global --add safe.directory /app/projects && \
    git config --global --add safe.directory '*' && \
    git config --global user.email "agent@shibaclassic.io" && \
    git config --global user.name "AITO Agent"

# Expose agent port (for health checks)
EXPOSE 3001

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:3001/health || exit 1

# Default command - merge claude-base into .claude volume, then start agent
# cp -rn = recursive, no-clobber (don't overwrite existing files like credentials)
# BUT: always force-update mcp_servers.json to ensure correct config
CMD ["sh", "-c", "cp -rn /app/claude-base/* /app/.claude/ 2>/dev/null || true; cp -f /app/claude-base/mcp_servers.json /app/.claude/mcp_servers.json 2>/dev/null || true; node dist/agents/index.js"]
